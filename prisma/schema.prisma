generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CUSTOMER
}

enum PaymentMethod {
  COD
  ONLINE
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String?
  
  // 1. New Field for Admin Customer Notes
  notes     String?   
  
  role      Role      @default(CUSTOMER)
  createdAt DateTime  @default(now())
  
  // Relations
  cart         Cart?
  wishlist     Wishlist?
  orders       Order[]
  reviews       Review[]
  addresses     Address[]
  // 2. New Relation for Activity Logs
  activityLogs ActivityLog[] 
}



model Product {
  id            String   @id @default(uuid())
  name          String
  description   String
  price         Float
  stock         Int
  category      String   // e.g. "T-Shirts", "Hoodies"
  images        String[] // Array of image URLs
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // --- NEW FIELDS ---
  originalPrice Float?   // For the "Save %" calculation
  gender        String?  // e.g. "Men", "Women", "Unisex", "Kids"
  tags          String[] @default([]) // e.g. ["New Arrival", "Summer Sale"]
  
  colors        Json?    @default("[]") 
  colorNames    String[] @default([])
  
  // Sizes Array: ["S", "M", "L"]
  sizes         String[] @default([])   
  
  // Details for Tabs
  features      String[] @default([])
  materials     String?
  care          String?
  
  // Relations
  orders        OrderItem[]
 reviews    Review[] 
 cartItems     CartItem[]
  wishlistItems WishlistItem[]
}

model Review {
  id        String   @id @default(uuid())
  rating    Int      // 1-5
  comment   String
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// --- NEW CART SYSTEM ---
model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  size      String?
  color     String?
}

// --- NEW WISHLIST SYSTEM ---
model Wishlist {
  id        String         @id @default(uuid())
  userId    String         @unique
  user      User           @relation(fields: [userId], references: [id])
  items     WishlistItem[]
}

model WishlistItem {
  id        String   @id @default(uuid())
  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id])
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  createdAt  DateTime @default(now())

  @@unique([wishlistId, productId]) // Prevent duplicates
}

// --- UPDATED ORDERS ---



// 2. Update the Order model
model Order {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])

  total             Decimal
  status            String   @default("PENDING")

  paymentMethod     PaymentMethod @default(ONLINE)
  // --- RAZORPAY & LOGIC ---
  razorpayOrderId   String?  @unique
  razorpayPaymentId String?
  metadata          Json?
  shippingAddress   Json?

  items             OrderItem[]
  
  // âœ… FIX: Add this line back to resolve the relation error
  refunds           Refund[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal
  size      String?
  color     String?
  refundItems RefundItem[]
}


model Refund {
  id              String       @id @default(uuid())
  orderId         String
  order           Order        @relation(fields: [orderId], references: [id])
  
  amount          Decimal      @db.Decimal(10, 2) // Amount refunded (could be partial)
  reason          String?      // e.g., "Wrong Size", "Defective"
  status          String       @default("PENDING") // PENDING, COMPLETED, REJECTED
  gatewayRefundId String?      // The ID from Stripe/Razorpay (e.g., re_3Kj...)
  
  items           RefundItem[] // Which items are included in this refund?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model RefundItem {
  id          String    @id @default(uuid())
  refundId    String
  refund      Refund    @relation(fields: [refundId], references: [id])
  
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  
  quantity    Int       // How many of this item are being returned?
}

model Settings {
  id          String   @id @default(uuid())
  siteName    String   @default("Rawwr Store")
  supportEmail String  @default("support@rawwr.com")
  taxRate     Decimal  @default(0.18)
  currency    String   @default("USD")
  updatedAt   DateTime @updatedAt
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String   // e.g., "UPDATED_PRODUCT", "REFUNDED_ORDER"
  details   String?  // JSON string or description
  createdAt DateTime @default(now())
}

model Address {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  name        String   // Recipient Name (e.g. "John Doe")
  phone       String   // Contact for delivery (e.g. "+1234567890")
  tag       String
  street    String
  city      String
  state     String
  zip       String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
}